<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Real-time</title>

  <!-- ✅ ใช้ไอคอน -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">

  <style>
    :root {
      --day-bg-color: #52a9d8;
      --night-bg-color: #2c3e50;
      --card-bg: rgba(0, 0, 0, 0.25);
      --card-border: rgba(255, 255, 255, 0.30);
      --text-primary: #fff;
      --text-secondary: #e0e0e0;
      --box-bg: rgba(0, 0, 0, 0.2);
      --accent: rgba(255, 255, 255, 0.85);
    }

    * {
      box-sizing: border-box;
    }

    body {
      background-image: none;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;

      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      min-height: 100vh;
      padding: 16px;
      color: var(--text-primary);
      background-color: var(--day-bg-color);
      transition: background-color .8s ease, background-image .8s ease;
      background-size: cover;
      background-position: center;

      display: flex;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }

    .container {
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
    }

    .card {
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      padding: 18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.25);
    }

    /* ✅ KEY FIX: ใช้ grid ล็อก right-controls ไปมุมขวาบน */
    .controls {
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-areas: "left right";
      align-items: start;
      gap: 12px;
      margin-bottom: 14px;
    }

    .left-controls {
      grid-area: left;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      min-width: 0;
    }

    .right-controls {
      grid-area: right;
      justify-self: end;
      align-self: start;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    select,
    button {
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(0, 0, 0, 0.20);
      color: white;
      padding: 10px 12px;
      outline: none;
    }

    button {
      cursor: pointer;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      min-height: 42px;
    }

    button:hover {
      background: rgba(0, 0, 0, 0.28);
    }

    .icon {
      width: 16px;
      height: 16px;
      display: inline-block;
    }

    .icon svg {
      width: 16px;
      height: 16px;
      fill: var(--accent);
    }

    .muted {
      color: var(--text-secondary);
      font-size: 14px;
    }

    #status {
      margin-top: 10px;
      min-height: 20px;
    }

    #error {
      margin-top: 10px;
      color: #ffd1d1;
    }

    .main-info {
      text-align: center;
      padding: 10px 0 6px;
    }

    .weather-icon {
      font-size: 56px;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.25));
    }

    .temp {
      margin: 8px 0 0;
      font-size: 48px;
    }

    .city {
      margin: 6px 0 0;
      font-size: 22px;
    }

    .subcity {
      margin-top: 4px;
    }

    .summary {
      margin-top: 8px;
      color: var(--text-secondary);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    .box {
      background: var(--box-bg);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 14px;
      padding: 12px;
    }

    .box-title {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .box-value {
      font-size: 18px;
      font-weight: 600;
    }

    /* ✅ แถบรายชั่วโมงแบบไอคอน (แทนกราฟ) */
    .hourly-wrap {
      margin-top: 14px;
      background: rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 14px;
      padding: 10px;
    }

    .hourly-title {
      margin-bottom: 8px;
    }

    .hourly-row {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(66px, 1fr);
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 6px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .hourly-row::-webkit-scrollbar {
      height: 8px;
    }

    .hourly-row::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.18);
      border-radius: 999px;
    }

    .hourly-row::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.08);
      border-radius: 999px;
    }

    .hour-item {
      scroll-snap-align: start;
      text-align: center;
      background: rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 14px;
      padding: 10px 8px;
      min-width: 66px;
    }

    .hour-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 6px;
      white-space: nowrap;
    }

    .hour-ico {
      font-size: 22px;
      line-height: 1;
      margin: 2px 0 6px;
      filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.25));
    }

    .hour-temp {
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
    }

    /* iOS-style unit switch */
    .unit-switch {
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .toggle {
      position: relative;
      width: 54px;
      height: 30px;
      background: rgba(255, 255, 255, 0.20);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 999px;
      cursor: pointer;
      flex: 0 0 auto;
      transition: background .2s ease;
    }

    .toggle input {
      display: none;
    }

    .knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 999px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
      transition: transform .2s ease;
    }

    .toggle input:checked+.knob {
      transform: translateX(24px);
    }

    .unit-pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.12);
      color: rgba(255, 255, 255, 0.85);
    }

    .unit-pill.active {
      background: rgba(255, 255, 255, 0.18);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.25);
    }

    /* Pretty select */
    select#locationSelect {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;

      width: 100%;
      min-width: 220px;
      padding: 10px 44px 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(0, 0, 0, 0.22);
      color: rgba(255, 255, 255, 0.95);

      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.2px;

      box-shadow:
        0 10px 18px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.12);

      transition: background .12s ease, border-color .12s ease, box-shadow .12s ease;
    }

    select#locationSelect:hover {
      background: rgba(0, 0, 0, 0.28);
      border-color: rgba(255, 255, 255, 0.30);
    }

    select#locationSelect:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.45);
      box-shadow:
        0 0 0 4px rgba(255, 255, 255, 0.12),
        0 10px 18px rgba(0, 0, 0, 0.15);
    }

    select#locationSelect option,
    select#locationSelect optgroup {
      font-weight: 600;
      color: #111;
    }

    .select-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      min-width: 220px;
      flex: 1 1 260px;
      max-width: 100%;
    }

    .select-wrap::after {
      content: "";
      position: absolute;
      right: 14px;
      width: 10px;
      height: 10px;
      border-right: 2px solid rgba(255, 255, 255, 0.85);
      border-bottom: 2px solid rgba(255, 255, 255, 0.85);
      transform: rotate(45deg);
      pointer-events: none;
      opacity: 0.9;
    }

    .select-wrap::before {
      content: "";
      position: absolute;
      right: 36px;
      width: 1px;
      height: 18px;
      background: rgba(255, 255, 255, 0.18);
      pointer-events: none;
    }

    /* -------------------- Responsive -------------------- */
    @media (max-width: 768px) {
      body {
        padding: 12px;
        align-items: flex-start;
      }

      .card {
        border-radius: 16px;
        padding: 16px;
      }

      .temp {
        font-size: 44px;
      }

      .city {
        font-size: 20px;
      }
    }

    /* ✅ มือถือ: สวิตช์อยู่ขวาบนแถวแรก, controls อยู่แถวถัดไป */
    @media (max-width: 480px) {
      .controls {
        grid-template-columns: 1fr auto;
        grid-template-areas:
          "right right"
          "left left";
        gap: 10px;
      }

      .right-controls {
        justify-self: end;
        align-self: start;
      }

      .left-controls {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      #btnGPS,
      #btnRefresh {
        width: 100%;
        justify-content: center;
      }

      .select-wrap {
        grid-column: 1 / -1;
        width: 100%;
        min-width: 0;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .temp {
        font-size: 40px;
      }

      .weather-icon {
        font-size: 52px;
      }

      .hourly-row {
        grid-auto-columns: minmax(62px, 1fr);
      }
    }

    @media (max-width: 360px) {
      .temp {
        font-size: 36px;
      }

      .city {
        font-size: 18px;
      }

      button {
        padding: 10px 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="controls">
        <div class="left-controls">
          <button id="btnGPS" title="ใช้ตำแหน่งปัจจุบัน">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 8a4 4 0 100 8 4 4 0 000-8zm9 3h-2.07A7.01 7.01 0 0013 5.07V3h-2v2.07A7.01 7.01 0 005.07 11H3v2h2.07A7.01 7.01 0 0011 18.93V21h2v-2.07A7.01 7.01 0 0018.93 13H21v-2zm-9 6a5 5 0 110-10 5 5 0 010 10z" />
              </svg>
            </span>
            <span>GPS</span>
          </button>

          <button id="btnRefresh" title="รีเฟรชข้อมูล">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path
                  d="M17.65 6.35A7.95 7.95 0 0012 4V1L7 6l5 5V7a5 5 0 11-5 5H5a7 7 0 107.75-6.95 7.9 7.9 0 014.9 2.3z" />
              </svg>
            </span>
            <span>Refresh</span>
          </button>

          <div class="select-wrap">
            <select id="locationSelect">
              <option value="">กำลังโหลดจังหวัด...</option>
            </select>
          </div>
        </div>

        <div class="right-controls">
          <div class="unit-switch" title="สลับหน่วยอุณหภูมิ">
            <span id="pillC" class="unit-pill active">°C</span>
            <label class="toggle">
              <input id="unitSwitch" type="checkbox" />
              <span class="knob"></span>
            </label>
            <span id="pillF" class="unit-pill">°F</span>
          </div>
        </div>
      </div>

      <div id="status" class="muted">กำลังเริ่มต้น…</div>
      <div id="error"></div>

      <div id="content" style="display:none;">
        <div class="main-info">
          <i id="weather-icon" class="weather-icon wi"></i>
          <h1 id="temp" class="temp">--</h1>
          <h2 id="city" class="city">--</h2>
          <div id="subcity" class="subcity muted"></div>
          <div id="summary" class="summary">--</div>
          <div id="relativeTime" class="muted" style="margin-top:8px;"></div>
        </div>

        <div class="grid">
          <div class="box">
            <div class="box-title">ลม</div>
            <div id="wind" class="box-value">--</div>
          </div>
          <div class="box">
            <div class="box-title">ความชื้น</div>
            <div id="humidity" class="box-value">--</div>
          </div>
        </div>

        <!-- ✅ แถบอุณหภูมิรายชั่วโมงแบบไอคอน -->
        <div class="hourly-wrap">
          <div class="muted hourly-title">อุณหภูมิรายชั่วโมง</div>
          <div id="hourlyRow" class="hourly-row" aria-label="พยากรณ์รายชั่วโมง"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const REFRESH_INTERVAL = 60000;
      const BANGKOK = { lat: 13.7563, lon: 100.5018, sourceLabel: 'กรุงเทพมหานคร' };

      let tempUnit = 'celsius';
      let currentQuery = { type: 'coords', value: { ...BANGKOK } };
      let isFetching = false;
      let refreshTimer = null;
      let relativeTimeTimer = null;
      let lastFetchTime = 0;

      const $btnGPS = document.getElementById('btnGPS');
      const $btnRefresh = document.getElementById('btnRefresh');
      const $locationSelect = document.getElementById('locationSelect');

      const $unitSwitch = document.getElementById('unitSwitch');
      const $pillC = document.getElementById('pillC');
      const $pillF = document.getElementById('pillF');

      const $status = document.getElementById('status');
      const $error = document.getElementById('error');
      const $content = document.getElementById('content');

      const $temp = document.getElementById('temp');
      const $cityEl = document.getElementById('city');
      const $subcityEl = document.getElementById('subcity');
      const $summary = document.getElementById('summary');
      const $wind = document.getElementById('wind');
      const $humidity = document.getElementById('humidity');
      const $weatherIcon = document.getElementById('weather-icon');
      const $relativeTime = document.getElementById('relativeTime');
      const $hourlyRow = document.getElementById('hourlyRow');

      function setError(msg) { $error.textContent = msg || ""; }
      function setLoading(msg) { $status.textContent = msg || ""; }

      function updateUnitPills() {
        const isF = $unitSwitch.checked;
        $pillC.classList.toggle('active', !isF);
        $pillF.classList.toggle('active', isF);
      }

      function updateRelativeTime() {
        if (!lastFetchTime) return;
        const sec = Math.floor((Date.now() - lastFetchTime) / 1000);
        if (sec < 5) $relativeTime.textContent = "อัปเดตเมื่อสักครู่";
        else if (sec < 60) $relativeTime.textContent = `อัปเดตเมื่อ ${sec} วินาทีที่แล้ว`;
        else $relativeTime.textContent = `อัปเดตเมื่อ ${Math.floor(sec / 60)} นาทีที่แล้ว`;
      }

      function weatherCodeToText(code) {
        const map = {
          0: "ท้องฟ้าแจ่มใส", 1: "เกือบแจ่มใส", 2: "มีเมฆบางส่วน", 3: "ครึ้มเมฆ",
          45: "หมอก", 48: "หมอกเกล็ดน้ำแข็ง",
          51: "ฝนปรอยเบา", 53: "ฝนปรอย", 55: "ฝนปรอยหนัก",
          61: "ฝนเบา", 63: "ฝน", 65: "ฝนหนัก",
          80: "ฝนซู่เบา", 81: "ฝนซู่", 82: "ฝนซู่หนัก",
          95: "พายุฝนฟ้าคะนอง"
        };
        return map[code] ?? `สภาพอากาศ (code: ${code})`;
      }

      function weatherCodeToIcon(code, isDay) {
        if (code === 0) return isDay ? 'wi-day-sunny' : 'wi-night-clear';
        if (code === 1 || code === 2) return isDay ? 'wi-day-cloudy' : 'wi-night-alt-cloudy';
        if (code === 3) return 'wi-cloudy';
        if (code === 45 || code === 48) return 'wi-fog';
        if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return 'wi-rain';
        if ([71, 73, 75].includes(code)) return 'wi-snow';
        if (code === 95) return 'wi-thunderstorm';
        return 'wi-cloud';
      }

      function formatHourLabel(isoTime) {
        const d = new Date(isoTime);
        return String(d.getHours()).padStart(2, '0') + ":00";
      }

      // ✅ ใหม่: เรนเดอร์รายชั่วโมงแบบไอคอน (แทนกราฟ)
      function renderHourlyIcons(hourly, unitShort, fallbackCode, fallbackIsDay) {
        if (!$hourlyRow) return;

        const times = hourly?.time || [];
        const temps = hourly?.temperature || [];
        const codes = hourly?.weather_code || hourly?.weathercode || [];
        const isDays = hourly?.is_day || hourly?.isDay || [];

        if (!times.length || !temps.length) {
          $hourlyRow.innerHTML = "";
          return;
        }

        // ✅ แสดง 24 ชั่วโมง ตั้งแต่ตอนนี้ถึง 24 ชั่วโมงข้างหน้า
        const MAX_ITEMS = 24;
        const len = Math.min(times.length, temps.length, MAX_ITEMS);

        let html = "";
        for (let i = 0; i < len; i++) {
          // ✅ คำนวณเวลา 24 ชั่วโมงถัดไป
          const currentTime = new Date();
          const futureTime = new Date(currentTime.getTime() + i * 3600000);
          const timeLabel = String(futureTime.getHours()).padStart(2, '0') + ":00";

          const tempVal = Number(temps[i]);
          const showTemp = Number.isFinite(tempVal) ? tempVal.toFixed(0) : "--";

          const code = (codes && codes.length > i && Number.isFinite(Number(codes[i])))
            ? Number(codes[i])
            : fallbackCode;

          const isDay = (isDays && isDays.length > i)
            ? !!Number(isDays[i])
            : !!fallbackIsDay;

          const iconClass = weatherCodeToIcon(code, isDay);

          html += `
            <div class="hour-item">
              <div class="hour-time">${timeLabel}</div>
              <i class="wi hour-ico ${iconClass}" aria-hidden="true"></i>
              <div class="hour-temp">${showTemp}°${unitShort}</div>
            </div>
          `;
        }

        $hourlyRow.innerHTML = html;
      }

      // ================= WEATHER BACKGROUND (IMAGE) =================
      const WEATHER_BG = {
        clear_day: "./bg/clear-day.jpg",
        clear_night: "./bg/clear-night.jpg",
        cloudy: "./bg/cloudy.jpg",
        rain: "./bg/rain.jpg",
        fog: "./bg/fog.jpg",
        snow: "./bg/snow.jpg",
        thunder: "./bg/thunder.jpg"
      };

      function applyWeatherBackground(code, isDay) {
        let key = null;

        if (code === 0) key = isDay ? "clear_day" : "clear_night";
        else if ([1, 2, 3].includes(code)) key = "cloudy";
        else if ([45, 48].includes(code)) key = "fog";
        else if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) key = "rain";
        else if ([71, 73, 75].includes(code)) key = "snow";
        else if (code === 95) key = "thunder";

        const body = document.body;

        if (!key) {
          body.style.backgroundImage = "none";
          return;
        }

        const imgUrl = WEATHER_BG[key];

        // ✅ เช็คว่ารูปโหลดได้จริงไหม (ถ้า 404 จะรู้ทันที)
        const probe = new Image();
        probe.onload = () => {
          body.style.backgroundImage = `url("${imgUrl}")`;
        };
        probe.onerror = () => {
          console.error("[BG] image not found:", imgUrl);
          // ถ้าคุณอยากให้เห็นบนหน้าเว็บด้วย ให้ปลดคอมเมนต์บรรทัดล่าง
          // document.getElementById("error").textContent = "BG ไม่พบไฟล์: " + imgUrl;
          body.style.backgroundImage = "none";
        };
        probe.src = imgUrl;
      }

      async function fetchWeather(isBackground = false) {
        if (isFetching) return;
        isFetching = true;
        setError("");
        if (!isBackground) setLoading("กำลังดึงข้อมูล...");

        try {
          let url = "weather.php?";
          if (currentQuery.type === 'coords') {
            url += `lat=${encodeURIComponent(currentQuery.value.lat)}&lon=${encodeURIComponent(currentQuery.value.lon)}&source=${encodeURIComponent(currentQuery.value.sourceLabel)}`;
          } else {
            url += `province=${encodeURIComponent(currentQuery.value.name)}&source=${encodeURIComponent(currentQuery.value.sourceLabel)}`;
          }
          url += `&unit=${tempUnit}`;

          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "Unknown error");

          lastFetchTime = Date.now();

          const w = json.data;
          const m = json.meta;

          $content.style.display = "block";
          $temp.textContent = `${Number(w.temperature_c).toFixed(1)}°${m.unit === 'celsius' ? 'C' : 'F'}`;

          const primaryLabel = (currentQuery.value && currentQuery.value.sourceLabel)
            ? currentQuery.value.sourceLabel
            : (m.source_label || '--');
          $cityEl.textContent = primaryLabel;

          const detail = m.locality || '';
          $subcityEl.textContent = detail ? `รายละเอียดตำแหน่ง: ${detail}` : '';

          $summary.textContent = weatherCodeToText(w.weather_code);
          $wind.textContent = `${Number(w.wind_kmh).toFixed(1)} km/h`;
          $humidity.textContent = `${Math.round(Number(w.humidity_percent))}%`;
          $weatherIcon.className = `weather-icon wi ${weatherCodeToIcon(w.weather_code, w.is_day)}`;

          applyWeatherBackground(w.weather_code, w.is_day);

          // ✅ แสดงรายชั่วโมงเป็นไอคอน
          const unitShort = (m.unit === 'celsius') ? 'C' : 'F';
          renderHourlyIcons(json.hourly, unitShort, w.weather_code, w.is_day);

          updateRelativeTime();
          if (!relativeTimeTimer) relativeTimeTimer = setInterval(updateRelativeTime, 5000);

          // ✅ ไม่แสดงข้อความ debug
          setLoading("");
        } catch (err) {
          $content.style.display = "none";
          setError(`ดึงข้อมูลไม่สำเร็จ: ${err.message}`);
          setLoading("มีข้อผิดพลาด");
        } finally {
          isFetching = false;
        }
      }

      function startAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(() => fetchWeather(true), REFRESH_INTERVAL);
      }

      function useBangkok() {
        currentQuery = { type: 'coords', value: { ...BANGKOK } };
        fetchWeather().then(startAutoRefresh);
      }

      function useGPS() {
        setError("");
        setLoading("กำลังขอสิทธิ์ตำแหน่ง (GPS)…");

        if (!navigator.geolocation) {
          setError("Browser นี้ไม่รองรับ Geolocation → ใช้ Bangkok");
          useBangkok();
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            currentQuery = { type: 'coords', value: { lat: pos.coords.latitude, lon: pos.coords.longitude, sourceLabel: "GPS" } };
            fetchWeather().then(startAutoRefresh);
          },
          (err) => {
            setError(`ขอ GPS ไม่สำเร็จ (${err.code}): ${err.message} → ใช้ Bangkok`);
            useBangkok();
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 30000 }
        );
      }

      async function setupSelectors() {
        try {
          const [regionsRes, provincesRes] = await Promise.all([fetch('regions.json'), fetch('provinces.json')]);
          if (!regionsRes.ok || !provincesRes.ok) throw new Error("โหลดไฟล์จังหวัดไม่ได้");

          const regions = await regionsRes.json();
          const provinces = await provincesRes.json();

          const provincesByRegion = provinces.reduce((acc, p) => {
            const id = p.GEO_ID;
            if (!acc[id]) acc[id] = [];
            acc[id].push(p);
            return acc;
          }, {});

          let html = '<option value="">เลือกจังหวัด...</option>';

          regions.forEach(r => {
            const list = provincesByRegion[r.GEO_ID];
            if (!list || list.length === 0) return;

            list.sort((a, b) => a.PROVINCE_NAME.localeCompare(b.PROVINCE_NAME, 'th'));
            html += `<optgroup label="${r.GEO_NAME}">`;
            list.forEach(p => {
              html += `<option value='${JSON.stringify({ name: p.PROVINCE_NAME })}'>${p.PROVINCE_NAME}</option>`;
            });
            html += `</optgroup>`;
          });

          $locationSelect.innerHTML = html;
        } catch (e) {
          setError("ไม่สามารถโหลดข้อมูลภาค/จังหวัดได้");
          console.error(e);
        }
      }

      function handleLocationChange() {
        const v = $locationSelect.value;
        if (!v) return;
        const obj = JSON.parse(v);
        currentQuery = { type: 'province', value: { name: obj.name, sourceLabel: obj.name } };
        fetchWeather().then(startAutoRefresh);
      }

      $btnGPS.addEventListener('click', useGPS);
      $btnRefresh.addEventListener('click', () => fetchWeather(false));
      $locationSelect.addEventListener('change', handleLocationChange);

      $unitSwitch.addEventListener('change', (e) => {
        tempUnit = e.target.checked ? 'fahrenheit' : 'celsius';
        updateUnitPills();
        fetchWeather(false);
      });

      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && (Date.now() - lastFetchTime > REFRESH_INTERVAL)) fetchWeather(true);
      });

      updateUnitPills();
      setupSelectors();
      useGPS();
    });

  </script>
</body>

</html>